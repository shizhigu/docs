---
title: Data Steward 架构
description: 内部开发笔记 - 数据存储设计
---

<Warning>
这是内部开发笔记，不对外公开。
</Warning>

## 存储架构概览

Data Steward 使用**双层存储**：

| 存储类型 | 用途 | 谁用 |
|----------|------|------|
| **SQLite** (steward.db) | 结构化数据、查询、状态管理 | Agent 程序化操作 |
| **Markdown 文件** | 人类可读文档、长文本知识 | 用户阅读、Agent 参考 |

---

## SQLite 数据库 (`/data/memory/steward.db`)

Agent 的"大脑"，用于程序化操作。

### 表结构

```sql
-- 任务队列
tasks (
    id, type, target, priority, status,
    created_at, started_at, completed_at, notes
)

-- 工作日志
work_log (
    id, iteration, task_id, action, result, timestamp
)

-- 告警记录（结构化）
alerts (
    id, type, severity, connection_id, table_name,
    title, description, status, created_at, resolved_at, metadata
)

-- KPI 历史（时序数据）
kpi_history (
    id, connection_id, kpi_name, value, previous_value,
    change_pct, recorded_at
)

-- Schema 快照（变化检测）
schema_snapshots (
    id, connection_id, table_name, column_info, row_count, snapshot_at
)

-- Agent 状态
agent_state (
    key, value, updated_at
)
```

### 典型用法

```python
import sqlite3
conn = sqlite3.connect('/data/memory/steward.db')

# 获取下一个任务
task = conn.execute('''
    SELECT * FROM tasks WHERE status = 'pending'
    ORDER BY priority DESC, created_at ASC LIMIT 1
''').fetchone()

# 记录 KPI
conn.execute('''
    INSERT INTO kpi_history (connection_id, kpi_name, value, change_pct)
    VALUES (?, ?, ?, ?)
''', (conn_id, 'daily_revenue', 125000, -12.3))
```

---

## 文件系统 (`/data/memory/`)

人类可读 + Agent 长文本知识。

### 目录结构

```
/data/memory/
│
├── steward.db                    # SQLite 数据库
│
├── profile.md                    # 用户画像
├── attention.md                  # 关注配置
│
├── docs/
│   └── task_guide.md             # Agent 任务指南
│
├── briefings/
│   ├── latest.md                 # 最新汇报（给老板看）
│   └── history/                  # 历史存档
│
├── sources/{conn_id}/
│   ├── understanding.md          # 业务语义理解
│   ├── quirks.md                 # 数据陷阱、坑
│   ├── patterns.md               # 常用查询模式
│   └── kpis.md                   # KPI 定义
│
├── monitoring/
│   └── scripts/                  # Agent 自己写的监控脚本
│
├── alerts/
│   ├── pending/                  # 待处理告警（Markdown 详情）
│   └── archive/                  # 已处理
│
├── insights/                     # 有价值的发现
│
└── snapshots/                    # 文件形式的快照（备用）
    ├── kpi/
    └── schema/
```

---

## 数据分工原则

### 写 SQLite 的场景

| 数据 | 为什么用 SQLite |
|------|-----------------|
| **任务队列** | 需要 ORDER BY、状态更新 |
| **工作日志** | 结构化查询、统计 |
| **告警记录** | 按状态筛选、计数 |
| **KPI 历史** | 时序分析、趋势计算 |
| **Schema 快照** | JSON 对比、变化检测 |

### 写文件的场景

| 数据 | 为什么用文件 |
|------|-------------|
| **briefings/latest.md** | 用户直接阅读 |
| **understanding.md** | 长文本、自由格式 |
| **quirks.md** | 追加式记录 |
| **kpis.md** | KPI 定义文档（不是历史值） |
| **监控脚本** | Python 代码文件 |

### 双写的场景

有些数据两边都有，用途不同：

| 数据 | SQLite | 文件 |
|------|--------|------|
| **Alerts** | 结构化记录（查询、统计） | Markdown 详情（人类阅读） |
| **KPI** | 历史值（kpi_history 表） | 定义文档（kpis.md） |

---

## Agent 工作流程

```
┌─────────────────────────────────────────────────────────┐
│  收到 "Continue Working" 消息                            │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│  1. 查询 SQLite: SELECT * FROM tasks WHERE status='pending' │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│  2. 执行任务（如 SCHEMA_AUDIT）                          │
│     - 读取数据源 schema                                  │
│     - 对比 schema_snapshots 表                          │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│  3. 写入结果                                             │
│     - INSERT INTO alerts (SQLite)                       │
│     - 写 alerts/pending/xxx.md (详情文件)                │
│     - INSERT INTO work_log (SQLite)                     │
│     - UPDATE tasks SET status='completed'               │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│  4. 如果是 DAILY_REPORT 任务                            │
│     - 查询 SQLite 汇总数据                              │
│     - 写 briefings/latest.md (人类可读)                 │
└─────────────────────────────────────────────────────────┘
```

---

## 初始化代码位置

| 组件 | 文件 | 函数 |
|------|------|------|
| SQLite Schema | `prompts_steward.py` | `SQLITE_SCHEMA` |
| 初始任务 | `prompts_steward.py` | `INITIAL_TASKS` |
| 任务指南 | `prompts_steward.py` | `TASK_GUIDE` |
| 目录创建 | `modal/agent.py` | `_init_memory_structure()` |
| DB 初始化 | `modal/agent.py` | `_init_steward_db()` |
| 指南写入 | `modal/agent.py` | `_init_task_guide()` |

---

## 待定 / 需要澄清

<Note>
以下是设计上还有点模糊的地方，需要后续明确：
</Note>

1. **alerts 双写**：SQLite 和文件都存，是否必要？
   - 当前：SQLite 存结构化，文件存详情
   - 考虑：是否可以只用 SQLite + 一个 description 字段？

2. **snapshots 目录**：目前有 `snapshots/kpi/` 和 `snapshots/schema/`，但 SQLite 也有表
   - 当前：两边都有
   - 考虑：文件可能是冗余的，SQLite 够用

3. **briefings 历史**：`briefings/history/` 目录存什么格式？
   - 考虑：`{date}.md` 文件名

4. **与 Analysis Agent 联动**：如何共享知识？
   - 当前：两个 Agent 独立
   - 考虑：Analysis Agent 启动时读取 `sources/{conn_id}/*.md`
